<style>
@import "../assets/weui.wxss";
.controller{
  padding: 15rpx
}
.title {
  padding: 20rpx 0;
  text-align: center;
  font-size: 30rpx;
  color: rgb(44, 151, 194);
}
image {
  height: 300rpx;
  width: 100%;
  background-color: rgba(219, 216, 216, 0.3);
}

.sub-btn {
  margin: 20rpx 15rpx;
}

.uploader-image {
  padding: 20rpx;
  background: url('http://pp6qq1rkn.bkt.clouddn.com/add.png')center center no-repeat;
  background-size: 120rpx 120rpx;
  border: 1px solid #95ebe3;
  box-shadow: 4rpx 4rpx 4rpx #95ebe3;
}
.result-box.weui-flex__item{
  width: 100rpx;
}
.result-box {
  margin: 20rpx 0;
  border: 1px solid #91dcdf;
  box-shadow: 5rpx 5rpx 5rpx  #91dcdf;

}
.item-box {
  width: 100%;
  height: 150rpx;
  padding: 10rpx;
  margin: 20rpx 0;
}
.write-box{
  width: 120rpx;
  height: 120rpx;
  margin-left: 50rpx;
  background: url('http://pp6qq1rkn.bkt.clouddn.com/writebg.jpg')center center no-repeat;
  background-size: 120rpx 120rpx;
  font-size: 70rpx;
  text-align: center;
  line-height: 120rpx
}

.write-rate {
  font-size: 24rpx;
  color: #444443;
  line-height: 120rpx;
}

.footer {
  padding: 60rpx 0;
  line-height: 30rpx;
  text-align: center;
  font-size: 24rpx;
}
</style>

<template>
  <view class="controller">
    <!-- ä¸Šä¼ å›¾ç‰‡å±•ç¤ºåŒº -->
    <view class="weui-flex" >
      <view class="weui-flex__item">
        <view>
          <view class="title" hidden='{{imageBool}}'><text class="title">ç‚¹å‡»æ·»åŠ ä¸Šä¼ å›¾ç‰‡</text></view>
          <view class=" discern-image uploader-image" @tap="uploadPhoto()"><image src="{{url}}" mode='widthFix'/></view>
        </view>
        <view hidden='{{resultBool}}' style="padding: 30rpx 0">
          <button type="primary" @tap="uploadImage()">å›¾ç‰‡ä¸Šä¼ è¯†åˆ«</button>
        </view>
      </view>
    </view>
    <!-- ç»“æœæ˜¾ç¤º -->
    <view class="result-box" hidden='{{!resultBool}}'>
      <view class="weui-flex item-box">
          <view class="weui-flex__item">
            <view class="write-box">{{result.word[0]}}</view>
          </view>
          <view class="weui-flex__item">
            <view class="write-rate">è¯†åˆ«ç‡ï¼š{{result.score[0]}}</view>
          </view>
      </view>

      <view class="weui-flex item-box">
          <view class="weui-flex__item">
            <view class="write-box">{{result.word[1]}}</view>
          </view>
          <view class="weui-flex__item">
            <view class="write-rate">è¯†åˆ«ç‡ï¼š{{result.score[1]}}</view>
          </view>
      </view>

      <view class="weui-flex item-box">
          <view class="weui-flex__item">
            <view class="write-box">{{result.word[2]}}</view>
          </view>
          <view class="weui-flex__item">
            <view class="write-rate">è¯†åˆ«ç‡ï¼š{{result.score[2]}}</view>
          </view>
      </view>
    </view>


    <!-- è¿”å›æŒ‰é’® -->
    <view style="padding: 20rpx">
      <button 
        class="weui-btn" 
        hidden='{{!resultBool}}' 
        type="default"  
        @tap="finish"> Back </button>
    </view>
    <!-- åº•éƒ¨ -->
    <view class="footer">
      <view class="weui-footer">
            <view class="weui-footer__links">
                <navigator url="" class="weui-footer__link">åº•éƒ¨</navigator>
            </view>
            <view class="weui-footer__text">Copyright Â© 2019-04-2019-08</view>
        </view>
    </view>
    </view>
</template>

<script>
import wepy from 'wepy'
export default class Write extends wepy.page {
  config = {
    navigationBarTitleText: 'æ‰‹å†™è¯†åˆ«'
  }

  data = {
    url: '',
    imageBool: false,
    resultBool: false,
    imgdata: '',
    result: ''
  }

  methods = {
    finish() {
      wx.navigateBack({
        delta: 1
      })
    },

    /**
     * é€‰æ‹©å›¾ç‰‡
     */
    uploadPhoto() {
      wx.chooseImage({
        count: 1,
        sourceType: ['album', 'camera'],
        success: res => {
          wx.showLoading({
            title: 'ä¸Šä¼ ä¸­ğŸ¤”ğŸ¤”ğŸ¤”'
          })
          this.url = res.tempFilePaths[0]
          this.imageBool = true
          let data = wx.getFileSystemManager().readFileSync(res.tempFilePaths[0], 'base64')
          this.imgdata = data
          this.$apply()
        },
        fail() {
          wx.showModal({
            title: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥â˜¹ï¸',
            content: 'æ‚¨å›¾ç‰‡ä¸Šä¼ å¤±è´¥äº†â˜¹ï¸'
          })
        },
        complete() {
          wx.hideLoading()
        }
      })
    },
    /**
     * å›¾ç‰‡è¯†åˆ«
     */
    uploadImage() {
      this.getDisCernByImg()
    }
  }

    /**
   * å›¾ç‰‡è¯·æ±‚
   */
  getDisCernByImg() {
    if (this.url === '') {
      wx.showModal({
        title: 'å¥½æ­¹ä½ ä¹Ÿç»™æˆ‘ä¸ªå›¾ç‰‡å•ŠğŸ˜«',
        content: 'ä½ ä¸ç»™æˆ‘å›¾ç‰‡è‡£å¦¾æ²¡åŠæ³•è¯†åˆ«å•Šâ˜¹ï¸'
      })
      return
    }

    wx.showLoading({
      title: 'è¯†åˆ«ä¸­ğŸ˜ğŸ˜ğŸ˜'
    })
    let that = this
    wx.request({
      url: 'http://106.14.145.218:9100/write',
      method: 'post',
      data: {imgData: this.imgdata, type: 1},
      success(res) {
        if (res.data.content.code === 200) {
          that.resultBool = true
          that.result = res.data.content.data
        } else {
          wx.showModal({
            title: 'è¯†åˆ«å¤±è´¥ğŸ˜­',
            content: 'å›¾ç‰‡æ ¼å¼ä¸æ­£ç¡®'
          })
        }
        that.$apply()
      },
      fail() {
        wx.showModal({
          title: 'è¯†åˆ«å¤±è´¥â˜¹ï¸',
          content: 'æŠ±æ­‰ï¼Œå¯èƒ½æœåŠ¡å™¨å‡ºå°å·®äº†ğŸ¤”'
        })
      },
      complete() {
        wx.hideLoading()
      }
    })
  }
}
</script>
