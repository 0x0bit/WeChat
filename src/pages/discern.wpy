<style>
@import "../assets/weui.wxss";
.controller{
  padding: 15rpx
}
.discern-image {
  padding: 0 20rpx;
  background: url('http://pp6qq1rkn.bkt.clouddn.com/image1.png') center center no-repeat;
  background-size: 90rpx 90rpx;
  border: 1px solid #91dcdf;
  box-shadow: 5rpx 5rpx 5rpx #91dcdf;
}
.title {
  padding: 20rpx 0;
  text-align: center;
  font-size: 30rpx;
  color: rgb(44, 151, 194);
}
image {
  height: 300rpx;
  width: 100%;
  background-color: rgba(219, 216, 216, 0.3);
}

.input-url {
  margin: 10rpx;
}

.weui-cell__bd {
  color: #757474;
  font-size: 24rpx;
}

.sub-btn {
  margin: 20rpx 15rpx;
}

.uploader-image {
  padding: 20rpx;
  background: url('http://pp6qq1rkn.bkt.clouddn.com/add.png')center center no-repeat;
  background-size: 120rpx 120rpx;
  border: 1px solid #95ebe3;
  box-shadow: 4rpx 4rpx 4rpx #95ebe3;
}

.result-box {
  margin-top: 20rpx;
  padding: 10rpx;
}

.result-panel {
  border: 1px solid #91dcdf;
  box-shadow: 5rpx 5rpx 5rpx #91dcdf;
}
.weui-media-box__desc {
  padding: 20rpx;
  line-height: 35rpx;
  font-size: 24rpx;
  color: black;
}

.footer {
  padding: 60rpx 0;
  line-height: 30rpx;
  text-align: center;
  font-size: 24rpx;
}
</style>

<template>
<!-- é“¾æ¥è¯†åˆ« -->
  <view class="page controller">
    <!-- é“¾æ¥è¯†åˆ« -->
    <view  wx:if="{{id == 1}}">
      <view class="weui-flex">
        <view class="weui-flex__item">
          <view class="title"><text class="title">å¾…è¯†åˆ«å›¾ç‰‡</text></view>
          <view class=" discern-image"><image src="{{url}}" mode='widthFix'/></view>
        </view>
      </view>
      <!-- é“¾æ¥è¾“å…¥æ¡† -->
      <view class="weui-flex input-url">
        <view class="weui-flex__item">
          <view class="weui-cells weui-cells_after-title">
            <view class="weui-cell">
                <view class="weui-cell__bd">
                  <textarea 
                    bindinput="bindKeyInput" 
                    class="weui-textarea"
                    placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥,ä¸è¶…è¿‡500å­—ç¬¦"
                    style="height: 3.3em" 
                    maxlength="500"
                    disabled='{{resultBool}}'/>
                </view>
            </view>
        </view>
        </view>
      </view>
      <!-- è¯†åˆ«æŒ‰é’® -->
      <view class="weui-flex sub-btn" hidden="{{resultBool}}">
        <view class="weui-flex__item">
          <button 
            class="weui-btn" 
            type="primary" 
            @tap="uploadimgUrl()">è¯†åˆ«</button>
        </view>
      </view>
    </view>

    <!-- ä¸Šä¼ å›¾ç‰‡è¯†åˆ« -->
    <view wx:if="{{id == 2}}">
      <view class="weui-flex" >
        <view class="weui-flex__item">
          <view>
            <view class="title" hidden='{{imageBool}}'><text class="title">ç‚¹å‡»æ·»åŠ ä¸Šä¼ å›¾ç‰‡</text></view>
            <view class=" discern-image uploader-image" @tap="uploadPhoto()"><image src="{{url}}" mode='widthFix'/></view>
          </view>
          <view hidden='{{resultBool}}' style="padding: 20rpx">
            <button type="primary" @tap="uploadImage()">å›¾ç‰‡ä¸Šä¼ è¯†åˆ«</button>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯†åˆ«ç»“æœ -->
    <view class="weui-flex result-box" hidden='{{!resultBool}}'>
      <view class="weui-flex__item">
        <view class="weui-panel result-panel">
            <view class="weui-panel__hd">è¯†åˆ«ç»“æœå¦‚ä¸‹ï¼š</view>
            <view class="weui-media-box__desc">{{result}}</view>
        </view>
      </view>
    </view>
    <view style="padding: 20rpx">
      <button 
      class="weui-btn" 
      hidden='{{!resultBool}}' 
      type="default"  
      @tap="finish"> Back </button>
    </view>
    <view class="footer">
      <view class="weui-footer">
            <view class="weui-footer__links">
                <navigator url="" class="weui-footer__link">åº•éƒ¨</navigator>
            </view>
            <view class="weui-footer__text">Copyright Â© 2019-04-2019-08</view>
        </view>
    </view>
  </view>
</template>

<script>
import wepy from 'wepy'
export default class Discern extends wepy.page {
  config = {
    navigationBarTitleText: 'è¯†åˆ«ä¸­å¿ƒ',
    window: {
      enablePullDownRefresh: false
    }
  }

  data = {
    id: 1,
    url: '',
    imageBool: false,
    resultBool: false,
    imgdata: '',
    result: ''
  }

  onLoad(options = {}) {
    this.id = options.id
    this.$apply()
  }

  methods = {
    finish() {
      wx.navigateBack({
        delta: 1
      })
    },

    /**
     * å›¾ç‰‡é“¾æ¥è¯†åˆ«
     */
    uploadimgUrl () {
      this.getDisCernByUrl()
    },

    /**
     * é€‰æ‹©å›¾ç‰‡
     */
    uploadPhoto() {
      wx.chooseImage({
        count: 1,
        sourceType: ['album', 'camera'],
        success: (res) => {
          wx.showLoading({
            title: 'ä¸Šä¼ ä¸­ğŸ¤”ğŸ¤”ğŸ¤”'
          })
          this.url = res.tempFilePaths[0]
          this.imageBool = true
          let data = wx.getFileSystemManager().readFileSync(res.tempFilePaths[0], 'base64')
          // data = data.replace(/\r\n/g,'');
          // data = data.replace(/\+/g, '%2B');
          this.imgdata = data
          this.$apply()
        },
        fail() {
          wx.showModal({
            title: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥â˜¹ï¸',
            content: 'æ‚¨å›¾ç‰‡ä¸Šä¼ å¤±è´¥äº†â˜¹ï¸'
          })
        },
        complete() {
          wx.hideLoading()
        }
      })
    },
    /**
     * å›¾ç‰‡è¯†åˆ«
     */
    uploadImage () {
      this.getDisCernByImg()
    }
  }

  /**
   * è·å–è¾“å…¥æ¡†è¾“å…¥
  */
  bindKeyInput(e) {
    this.url = e.detail.value
  }

  // -------------------------------------------------------
  /**
   * é€šè¿‡å›¾ç‰‡urlè¯†åˆ«
   */
  getDisCernByUrl () {
    const regex = /(.*)\\.(jpg|jpeg|png)$/
    if (this.url === '') {
      wx.showModal({
        title: 'å¥½æ­¹ä½ ä¹Ÿç»™æˆ‘ä¸ªåœ°å€å•ŠğŸ˜«',
        content: 'ä½ ä¸ç»™æˆ‘åœ°å€è‡£å¦¾æ²¡åŠæ³•è¯†åˆ«å•Šâ˜¹ï¸'
      })
      return
    }

    if (regex.test(this.url)) {
      wx.showModal({
        title: 'ç»™ä¸ªæ­£ç¡®çš„å›¾ç‰‡åœ°å€å•ŠğŸ˜«',
        content: 'ä½ ç»™æˆ‘æ­£ç¡®çš„å›¾ç‰‡åœ°å€è‡£å¦¾æ²¡åŠæ³•è¯†åˆ«å•Šâ˜¹ï¸'
      })
      return
    }

    wx.showLoading({
      title: 'è¯†åˆ«ä¸­ğŸ¤”ğŸ¤”ğŸ¤”'
    })

    let that = this
    wx.request({
      url: 'http://106.14.145.218:9100/baidu/api/discern',
      method: 'post',
      data: {imgOrUrl: this.url},
      success(res) {
        if (res.data.content.code === 200) {
          that.resultBool = true
          that.result = res.data.content.word.join(' ')
          that.$apply()
        } else {
          wx.showModal({
            title: 'è¯†åˆ«å¤±è´¥â˜¹ï¸',
            content: 'æ²¡æœ‰æ‰¾åˆ°ä½ ç»™æˆ‘é“¾æ¥çš„å›¾ç‰‡â˜¹ï¸'
          })
        }
      },
      fail() {
        wx.showModal({
          title: 'è¯†åˆ«å¤±è´¥â˜¹ï¸',
          content: 'æŠ±æ­‰ï¼Œå¯èƒ½æœåŠ¡å™¨å‡ºå°å·®äº†â˜¹ï¸'
        })
      },
      complete() {
        wx.hideLoading()
      }
    })
  }

  /**
   * å›¾ç‰‡è¯·æ±‚
   */
  getDisCernByImg() {
    if (this.url === '') {
      wx.showModal({
        title: 'å¥½æ­¹ä½ ä¹Ÿç»™æˆ‘ä¸ªå›¾ç‰‡å•ŠğŸ˜«',
        content: 'ä½ ä¸ç»™æˆ‘å›¾ç‰‡è‡£å¦¾æ²¡åŠæ³•è¯†åˆ«å•Šâ˜¹ï¸'
      })
      return
    }

    wx.showLoading({
      title: 'è¯†åˆ«ä¸­ğŸ˜ğŸ˜ğŸ˜'
    })
    let that = this

    wx.request({
      url: 'http://106.14.145.218:9100/baidu/api/discern',
      method: 'post',
      data: {imgOrUrl: this.imgdata},
      success(res) {
        if (res.data.content.code === 200) {
          that.resultBool = true
          that.result = res.data.content.word.join(' ')
        } else {
          wx.showModal({
            title: 'è¯†åˆ«å¤±è´¥ğŸ˜­',
            content: 'å›¾ç‰‡æ ¼å¼ä¸æ­£ç¡®'
          })
        }
        that.$apply()
      },
      fail() {
        wx.showModal({
          title: 'è¯†åˆ«å¤±è´¥â˜¹ï¸',
          content: 'æŠ±æ­‰ï¼Œå¯èƒ½æœåŠ¡å™¨å‡ºå°å·®äº†ğŸ¤”'
        })
      },
      complete() {
        wx.hideLoading()
      }
    })
  }
}
</script>
